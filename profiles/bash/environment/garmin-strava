if [[ -z "$GARMIN_MOUNT" ]]; then
	echo "GARMIN_MOUNT should be set before sourcing garmin-strava"
fi

export GARMIN_ACTIVITIES_DIR="$GARMIN_MOUNT/Garmin/Activities"
export GARMIN_NEWFILES_DIR="$GARMIN_MOUNT/Garmin/NewFiles"

garmin-upload-and-archive-downloaded-routes() {
	local routes="$(find "$HOME/Downloads" \
		-iname '*.tcx' \
		-or \
		-iname '*.gpx')"

	if [[ "$routes" = "" ]]; then
		echo "No routes found."
		return 1
	fi

	garmin-upload-and-archive-routes "$routes"
}

garmin-upload-and-archive-routes() {
	local usage="usage: garmin-upload-and-archive-routes ROUTES..."
	local routes="${1:?"$usage"}"

	if [[ ! -d "$GARMIN_NEWFILES_DIR" ]]; then
		echo "Garmin new files directory not found at '$GARMIN_NEWFILES_DIR'"
		return 1
	fi

	if [[ ! -d "$CYCLING_ROUTES_ARCHIVE" ]]; then
		echo "Cycling routes archive directory not found at '$CYCLING_ROUTES_ARCHIVE'"
		return 2
	fi

	for dir in "$GARMIN_NEWFILES_DIR" "$CYCLING_ROUTES_ARCHIVE"; do
		parallel cp -v {} "$dir/" ::: "$routes"
		local code="$?"
		if [[ "$code" -ne "0" ]]; then
			echo "parallel exited with code: $code"
			echo "not continuing"
			return 3
		fi
	done

	parallel trash -v ::: "$routes"
}

strava-upload() {
	local usage="Usage: strava-upload <filename>"
	local filename="${1:?$usage}"
	local file="$GARMIN_ACTIVITIES_DIR/$filename"
	local name="${2}"
	if [[ -z "$STRAVA_KEY" ]]; then
		echo STRAVA_KEY is not set
		return 1
	fi

	curl -X POST https://www.strava.com/api/v3/uploads \
	    -H "Authorization: Bearer ${STRAVA_KEY}" \
	    -H "accept: application/json" \
	    -H "Content-Type: multipart/form-data" \
	    -F file="@$file" \
	    -F name="$name" \
	    -F data_type=fit \
	    | jq .
}

_strava-upload-completion() {
	COMPREPLY=();
    local word="${COMP_WORDS[COMP_CWORD]}";
    COMPREPLY=($(compgen -W "$(find $GARMIN_ACTIVITIES_DIR -iname "${word}*.fit" -printf "%f\n")" -- "$word"));
}

complete -F '_strava-upload-completion' strava-upload

strava-upload-and-archive() {
	local usage="usage: strava-upload-and-archive ACTIVITY"
	local activity="${1:?$usage}"
	local name="${2}"

	if [[ ! -d "$GARMIN_ACTIVITIES_DIR" ]]; then
		echo "Garmin activities directory not found at '$GARMIN_ACTIVITIES_DIR'"
		return 1
	fi

	if [[ ! -d "$CYCLING_ACTIVITIES_ARCHIVE" ]]; then
		echo "Cycling activities directory not found at '$CYCLING_ACTIVITIES_ARCHIVE'"
		return 2
	fi

	strava-upload "$@"
	local code="$?"
	if [[ "$code" -ne "0" ]]; then
		echo "strava-upload  exited with code: $code"
		echo "not continuing"
		return 3
	fi

	mv -v "$GARMIN_ACTIVITIES_DIR/$activity" "$CYCLING_ACTIVITIES_ARCHIVE/$activity"
}

complete -F '_strava-upload-completion' strava-upload-and-archive
